# Firebase Firestore Database Structure

This document outlines the complete database structure for the Project Blog application, including user profiles, blog posts, likes, and related data.

## Collections Overview

### 1. `users` Collection
Stores user profile information and statistics.

**Document ID**: User's Firebase Auth UID

**Fields**:
```dart
{
  "uid": String,                    // User's Firebase Auth UID
  "email": String,                  // User's email address
  "username": String,               // Unique username
  "photoURL": String?,              // Profile picture URL (Firebase Storage)
  "bio": String?,                   // User's bio/description
  "createdAt": Timestamp,           // Account creation date
  "lastLoginAt": Timestamp,         // Last login timestamp
  "followersCount": Number,         // Number of followers
  "followingCount": Number,         // Number of users being followed
  "postsCount": Number,             // Number of blog posts created
  "interests": Array<String>,       // User's interests/tags
  "isVerified": Boolean,            // Verification status
}
```

**Example**:
```json
{
  "uid": "abc123xyz",
  "email": "john@example.com",
  "username": "johndoe",
  "photoURL": "https://firebasestorage.googleapis.com/v0/b/.../profile_pictures/abc123xyz.jpg",
  "bio": "Tech enthusiast and blogger",
  "createdAt": "2025-07-31T10:00:00Z",
  "lastLoginAt": "2025-07-31T15:30:00Z",
  "followersCount": 150,
  "followingCount": 75,
  "postsCount": 25,
  "interests": ["technology", "travel", "food"],
  "isVerified": false
}
```

### 2. `blogs` Collection
Stores all blog posts and their metadata.

**Document ID**: Auto-generated by Firestore

**Fields**:
```dart
{
  "authorId": String,               // Reference to user document
  "authorUsername": String,         // Author's username (denormalized)
  "authorPhotoURL": String?,        // Author's profile picture (denormalized)
  "title": String,                  // Blog post title
  "content": String,                // Blog post content (HTML/Markdown)
  "imageURL": String?,              // Featured image URL (Firebase Storage)
  "tags": Array<String>,            // Blog tags for categorization
  "createdAt": Timestamp,           // Post creation date
  "updatedAt": Timestamp,           // Last modification date
  "likesCount": Number,             // Number of likes (denormalized)
  "commentsCount": Number,          // Number of comments (future feature)
  "viewsCount": Number,             // Number of views
  "isPublished": Boolean,           // Publication status
  "category": String,               // Blog category
}
```

**Example**:
```json
{
  "authorId": "abc123xyz",
  "authorUsername": "johndoe",
  "authorPhotoURL": "https://firebasestorage.googleapis.com/v0/b/.../profile_pictures/abc123xyz.jpg",
  "title": "Getting Started with Flutter Development",
  "content": "<p>Flutter is an amazing framework...</p>",
  "imageURL": "https://firebasestorage.googleapis.com/v0/b/.../blog_images/def456uvw.jpg",
  "tags": ["flutter", "mobile", "development"],
  "createdAt": "2025-07-31T14:00:00Z",
  "updatedAt": "2025-07-31T14:00:00Z",
  "likesCount": 42,
  "commentsCount": 8,
  "viewsCount": 156,
  "isPublished": true,
  "category": "Technology"
}
```

### 3. `likes` Collection
Stores like relationships between users and blogs.

**Document ID**: Auto-generated by Firestore

**Fields**:
```dart
{
  "userId": String,                 // Reference to user who liked
  "blogId": String,                 // Reference to liked blog
  "blogAuthorId": String,           // Reference to blog author (for notifications)
  "createdAt": Timestamp,           // When the like was created
}
```

**Example**:
```json
{
  "userId": "xyz789abc",
  "blogId": "def456uvw",
  "blogAuthorId": "abc123xyz",
  "createdAt": "2025-07-31T15:45:00Z"
}
```

### 4. `comments` Collection (Future Feature)
For storing blog comments.

**Document ID**: Auto-generated by Firestore

**Fields**:
```dart
{
  "blogId": String,                 // Reference to blog
  "authorId": String,               // Reference to comment author
  "authorUsername": String,         // Author's username (denormalized)
  "authorPhotoURL": String?,        // Author's profile picture (denormalized)
  "content": String,                // Comment content
  "createdAt": Timestamp,           // Comment creation date
  "updatedAt": Timestamp,           // Last modification date
  "likesCount": Number,             // Number of likes on comment
  "parentCommentId": String?,       // For nested comments (replies)
}
```

## Firebase Storage Structure

### Profile Pictures
- **Path**: `/profile_pictures/{userId}.jpg`
- **Access**: Public read, authenticated write (only by owner)

### Blog Images
- **Path**: `/blog_images/{blogId}.jpg`
- **Access**: Public read, authenticated write (only by blog author)

## Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection
    match /users/{userId} {
      allow read: if true; // Public profiles
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Blogs collection
    match /blogs/{blogId} {
      allow read: if resource.data.isPublished == true || 
                     (request.auth != null && request.auth.uid == resource.data.authorId);
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.authorId;
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.authorId;
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.authorId;
    }
    
    // Likes collection
    match /likes/{likeId} {
      allow read: if true;
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.userId;
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }
    
    // Comments collection (future)
    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.authorId;
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.authorId;
      allow delete: if request.auth != null && 
                       (request.auth.uid == resource.data.authorId ||
                        request.auth.uid == get(/databases/$(database)/documents/blogs/$(resource.data.blogId)).data.authorId);
    }
  }
}
```

## Common Queries

### Get Recent Blogs
```dart
_firestore.collection('blogs')
  .where('isPublished', isEqualTo: true)
  .orderBy('createdAt', descending: true)
  .limit(20)
```

### Get User's Blogs
```dart
_firestore.collection('blogs')
  .where('authorId', isEqualTo: userId)
  .where('isPublished', isEqualTo: true)
  .orderBy('createdAt', descending: true)
```

### Get Liked Blogs by User
```dart
// First get like documents
_firestore.collection('likes')
  .where('userId', isEqualTo: userId)
  .orderBy('createdAt', descending: true)

// Then fetch each blog document
```

### Check if User Liked Blog
```dart
_firestore.collection('likes')
  .where('userId', isEqualTo: userId)
  .where('blogId', isEqualTo: blogId)
  .limit(1)
```

## Indexing Strategy

**Composite Indexes Needed**:

1. **blogs** collection:
   - `isPublished` + `createdAt` (descending)
   - `authorId` + `isPublished` + `createdAt` (descending)
   - `category` + `isPublished` + `createdAt` (descending)

2. **likes** collection:
   - `userId` + `createdAt` (descending)
   - `blogId` + `createdAt` (descending)
   - `userId` + `blogId`

## Data Denormalization

To improve performance, some data is denormalized:
- Blog documents store `authorUsername` and `authorPhotoURL`
- Blog documents store `likesCount` and `commentsCount`
- User documents store `postsCount`, `followersCount`, `followingCount`

## Pagination

For large datasets, implement pagination using:
- `startAfter()` for cursor-based pagination
- `limit()` to control page size
- Store last document for next page queries

## Best Practices Implemented

1. **Denormalization**: Critical data is duplicated for better read performance
2. **Atomic Updates**: Use transactions for operations that affect multiple documents
3. **Batch Operations**: Use batch writes for multiple related operations
4. **Optimistic UI**: Update UI immediately, handle errors gracefully
5. **Caching**: Cache frequently accessed data locally
6. **Lazy Loading**: Load data as needed to improve initial app performance
